"""
æµ‹è¯•æ³•å¾‹è´¢åŠ¡ä¸“å®¶Agentç³»ç»Ÿ
éªŒè¯æ³•å¾‹åˆè§„ä¸“å®¶å’Œè´¢åŠ¡ä¸“å®¶çš„åŠŸèƒ½
"""
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import asyncio
from legal_finance_skills import (
    search_legal_knowledge, search_financial_knowledge,
    get_contract_review_template, get_financial_statement_template,
    get_variance_analysis_template
)
from agent_framework import BaseAgent, AgentConfig


def test_legal_skills():
    """æµ‹è¯•æ³•å¾‹ç›¸å…³æŠ€èƒ½å·¥å…·ï¼ˆéªŒè¯å·¥å…·å¯ä»¥æ­£ç¡®å¯¼å…¥å’Œä½¿ç”¨ï¼‰"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•1: æ³•å¾‹æŠ€èƒ½å·¥å…·")
    print("=" * 80)
    
    print("âœ… æ³•å¾‹æŠ€èƒ½å·¥å…·å¯¼å…¥æˆåŠŸ")
    print("   å¯ç”¨å·¥å…·: [search_legal_knowledge, get_contract_review_template]")
    
    return True


def test_finance_skills():
    """æµ‹è¯•è´¢åŠ¡ç›¸å…³æŠ€èƒ½å·¥å…·ï¼ˆéªŒè¯å·¥å…·å¯ä»¥æ­£ç¡®å¯¼å…¥å’Œä½¿ç”¨ï¼‰"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•2: è´¢åŠ¡æŠ€èƒ½å·¥å…·")
    print("=" * 80)
    
    print("âœ… è´¢åŠ¡æŠ€èƒ½å·¥å…·å¯¼å…¥æˆåŠŸ")
    print("   å¯ç”¨å·¥å…·: [search_financial_knowledge, get_financial_statement_template, get_variance_analysis_template]")
    
    return True


def test_legal_expert_config():
    """æµ‹è¯•æ³•å¾‹ä¸“å®¶é…ç½®"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•3: æ³•å¾‹ä¸“å®¶é…ç½®")
    print("=" * 80)
    
    config = AgentConfig(
        name="legal_expert",
        role="æ³•å¾‹åˆè§„ä¸“å®¶",
        description="è´Ÿè´£åˆåŒå®¡æŸ¥ã€æ³•å¾‹é£é™©è¯„ä¼°ã€åˆè§„æ£€æŸ¥",
        system_prompt="""ä½ æ˜¯ä¸€ä½èµ„æ·±æ³•å¾‹åˆè§„ä¸“å®¶ã€‚""",
        tools=[search_legal_knowledge, get_contract_review_template]
    )
    
    assert config.name == "legal_expert"
    assert config.role == "æ³•å¾‹åˆè§„ä¸“å®¶"
    assert len(config.tools) == 2
    
    print("âœ… æ³•å¾‹ä¸“å®¶é…ç½®åˆ›å»ºæˆåŠŸ")
    print("   ä¸“å®¶åç§°:", config.name)
    print("   ä¸“å®¶è§’è‰²:", config.role)
    print("   å¯ç”¨å·¥å…·:", [t.name for t in config.tools])
    
    agent = config.create_agent()
    assert isinstance(agent, BaseAgent)
    print("âœ… é€šè¿‡é…ç½®æˆåŠŸåˆ›å»ºæ³•å¾‹ä¸“å®¶Agentå®ä¾‹")
    
    return config


def test_finance_expert_config():
    """æµ‹è¯•è´¢åŠ¡ä¸“å®¶é…ç½®"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•4: è´¢åŠ¡ä¸“å®¶é…ç½®")
    print("=" * 80)
    
    config = AgentConfig(
        name="finance_expert",
        role="è´¢åŠ¡ä¸“å®¶",
        description="è´Ÿè´£è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆã€å·®å¼‚åˆ†æã€æ—¥è®°è´¦å‡†å¤‡",
        system_prompt="""ä½ æ˜¯ä¸€ä½èµ„æ·±è´¢åŠ¡ä¸“å®¶ã€‚""",
        tools=[search_financial_knowledge, get_financial_statement_template, get_variance_analysis_template]
    )
    
    assert config.name == "finance_expert"
    assert config.role == "è´¢åŠ¡ä¸“å®¶"
    assert len(config.tools) == 3
    
    print("âœ… è´¢åŠ¡ä¸“å®¶é…ç½®åˆ›å»ºæˆåŠŸ")
    print("   ä¸“å®¶åç§°:", config.name)
    print("   ä¸“å®¶è§’è‰²:", config.role)
    print("   å¯ç”¨å·¥å…·:", [t.name for t in config.tools])
    
    agent = config.create_agent()
    assert isinstance(agent, BaseAgent)
    print("âœ… é€šè¿‡é…ç½®æˆåŠŸåˆ›å»ºè´¢åŠ¡ä¸“å®¶Agentå®ä¾‹")
    
    return config


async def test_legal_expert_invoke():
    """æµ‹è¯•æ³•å¾‹ä¸“å®¶Agentè°ƒç”¨"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•5: æ³•å¾‹ä¸“å®¶Agentè°ƒç”¨")
    print("=" * 80)
    
    config = AgentConfig(
        name="legal_expert",
        role="æ³•å¾‹åˆè§„ä¸“å®¶",
        description="è´Ÿè´£åˆåŒå®¡æŸ¥ã€æ³•å¾‹é£é™©è¯„ä¼°ã€åˆè§„æ£€æŸ¥",
        system_prompt="""ä½ æ˜¯ä¸€ä½èµ„æ·±æ³•å¾‹åˆè§„ä¸“å®¶ã€‚è¯·ç»™å‡ºä¸“ä¸šçš„æ³•å¾‹åˆ†æå»ºè®®ã€‚

é‡è¦å…è´£å£°æ˜ï¼šä½ ååŠ©å¤„ç†æ³•å¾‹å·¥ä½œæµç¨‹ï¼Œä½†ä¸æä¾›æ³•å¾‹å»ºè®®ã€‚æ‰€æœ‰åˆ†æåº”ç”±åˆæ ¼çš„æ³•å¾‹ä¸“ä¸šäººå‘˜å®¡æŸ¥åæ‰èƒ½ä¾èµ–ã€‚

è¯·åœ¨å›ç­”å¼€å¤´æ˜ç¡®è¯´æ˜ï¼šã€æ³•å¾‹åˆè§„ä¸“å®¶æŠ¥å‘Šã€‘
""",
        tools=[search_legal_knowledge, get_contract_review_template]
    )
    
    agent = config.create_agent()
    
    print("æ­£åœ¨è°ƒç”¨æ³•å¾‹ä¸“å®¶Agent...")
    result = await agent.ainvoke("è¯·ç®€å•ä»‹ç»ä¸€ä¸‹åˆåŒå®¡æŸ¥çš„ä¸»è¦å†…å®¹")
    
    assert "output" in result
    assert len(result["output"]) > 0
    
    print("âœ… æ³•å¾‹ä¸“å®¶Agentè°ƒç”¨æˆåŠŸ")
    print("   è¾“å‡ºé•¿åº¦:", len(result["output"]), "å­—ç¬¦")
    print("   è¾“å‡ºé¢„è§ˆ:", result["output"][:100], "...")
    
    return result


async def test_finance_expert_invoke():
    """æµ‹è¯•è´¢åŠ¡ä¸“å®¶Agentè°ƒç”¨"""
    print("\n" + "=" * 80)
    print("æµ‹è¯•6: è´¢åŠ¡ä¸“å®¶Agentè°ƒç”¨")
    print("=" * 80)
    
    config = AgentConfig(
        name="finance_expert",
        role="è´¢åŠ¡ä¸“å®¶",
        description="è´Ÿè´£è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆã€å·®å¼‚åˆ†æã€æ—¥è®°è´¦å‡†å¤‡",
        system_prompt="""ä½ æ˜¯ä¸€ä½èµ„æ·±è´¢åŠ¡ä¸“å®¶ã€‚è¯·ç»™å‡ºä¸“ä¸šçš„è´¢åŠ¡åˆ†æå»ºè®®ã€‚

é‡è¦å…è´£å£°æ˜ï¼šä½ ååŠ©å¤„ç†è´¢åŠ¡å·¥ä½œæµç¨‹ï¼Œä½†ä¸æä¾›è´¢åŠ¡å»ºè®®ã€‚æ‰€æœ‰æŠ¥è¡¨åº”ç”±åˆæ ¼çš„è´¢åŠ¡ä¸“ä¸šäººå‘˜å®¡æŸ¥åæ‰èƒ½ç”¨äºæŠ¥å‘Šæˆ–ç”³æŠ¥ã€‚

è¯·åœ¨å›ç­”å¼€å¤´æ˜ç¡®è¯´æ˜ï¼šã€è´¢åŠ¡ä¸“å®¶æŠ¥å‘Šã€‘
""",
        tools=[search_financial_knowledge, get_financial_statement_template, get_variance_analysis_template]
    )
    
    agent = config.create_agent()
    
    print("æ­£åœ¨è°ƒç”¨è´¢åŠ¡ä¸“å®¶Agent...")
    result = await agent.ainvoke("è¯·ç®€å•ä»‹ç»ä¸€ä¸‹åˆ©æ¶¦è¡¨çš„ä¸»è¦ç»“æ„")
    
    assert "output" in result
    assert len(result["output"]) > 0
    
    print("âœ… è´¢åŠ¡ä¸“å®¶Agentè°ƒç”¨æˆåŠŸ")
    print("   è¾“å‡ºé•¿åº¦:", len(result["output"]), "å­—ç¬¦")
    print("   è¾“å‡ºé¢„è§ˆ:", result["output"][:100], "...")
    
    return result


def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\n" + "=" * 80)
    print("å¼€å§‹æµ‹è¯•æ³•å¾‹è´¢åŠ¡ä¸“å®¶Agentç³»ç»Ÿ")
    print("=" * 80)
    
    try:
        test_legal_skills()
        test_finance_skills()
        test_legal_expert_config()
        test_finance_expert_config()
        
        asyncio.run(test_legal_expert_invoke())
        asyncio.run(test_finance_expert_invoke())
        
        print("\n" + "=" * 80)
        print("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ³•å¾‹è´¢åŠ¡ä¸“å®¶Agentç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼")
        print("=" * 80)
        print("\næ ¸å¿ƒåŠŸèƒ½éªŒè¯:")
        print("  âœ… æ³•å¾‹æŠ€èƒ½å·¥å…· - çŸ¥è¯†åº“æœç´¢å’Œæ¨¡æ¿è·å–")
        print("  âœ… è´¢åŠ¡æŠ€èƒ½å·¥å…· - çŸ¥è¯†åº“æœç´¢å’Œæ¨¡æ¿è·å–")
        print("  âœ… æ³•å¾‹ä¸“å®¶é…ç½® - é€šè¿‡AgentConfigåˆ›å»ºæ³•å¾‹ä¸“å®¶")
        print("  âœ… è´¢åŠ¡ä¸“å®¶é…ç½® - é€šè¿‡AgentConfigåˆ›å»ºè´¢åŠ¡ä¸“å®¶")
        print("  âœ… æ³•å¾‹ä¸“å®¶è°ƒç”¨ - AgentæˆåŠŸå¤„ç†æ³•å¾‹ç›¸å…³é—®é¢˜")
        print("  âœ… è´¢åŠ¡ä¸“å®¶è°ƒç”¨ - AgentæˆåŠŸå¤„ç†è´¢åŠ¡ç›¸å…³é—®é¢˜")
        
    except Exception as e:
        print("\nâŒ æµ‹è¯•å¤±è´¥:", str(e))
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    run_all_tests()