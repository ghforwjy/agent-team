# Agent系统 - 傻瓜教程

## 目录
1. [什么是蜂群式Agent系统？](#1-什么是蜂群式agent系统)
2. [用到的工具：LangChain、LangGraph](#2-用到的工具langchainlanggraph)
3. [核心框架详解](#3-核心框架详解)
4. [法律财务专家系统实现](#4-法律财务专家系统实现)
5. [模块化Agent架构](#5-模块化agent架构)
6. [knowledge-work-plugins集成详解](#6-knowledge-work-plugins集成详解)
7. [SKILL.md知识加载机制](#7-skillmd知识加载机制)
8. [如何扩展新专家](#8-如何扩展新专家)
9. [运行指南](#9-运行指南)

---

## 1. 什么是蜂群式Agent系统？

### 用生活中的例子理解

想象一下你去一家大医院看病：

```
你（患者） → 前台导诊（协调员） → 根据病情分配 → 
                              ↓
                    ┌─────────┼─────────┐
                    ↓         ↓         ↓
                  内科医生   外科医生   牙科医生  （专家Agent）
                    ↓         ↓         ↓
                  给你看病   给你看病   给你看病
```

**蜂群式Agent系统**就像这个医院：

- **协调员** = 前台导诊（先判断你是什么问题）
- **专家Agent** = 各个科室的医生（专门处理某一类问题）
- **用户** = 患者（提出问题）
- **工具库** = 医院的检查设备和病历库
- **大模型** = 超级聪明的医生顾问

---

## 2. 用到的工具：LangChain、LangGraph

### LangChain - "积木盒子"

**LangChain是什么？**

想象你要搭一个机器人，LangChain就是给你准备好了各种积木：
- 连接大模型的积木
- 连接数据库的积木  
- 调用工具的积木
- 记忆对话的积木

**在我们的代码里怎么用的？**

```python
from langchain_openai import ChatOpenAI  # 连接大模型的积木
from langchain.tools import tool          # 定义工具的装饰器

llm = ChatOpenAI(
    model="doubao-seed-2-0-mini-260215",  # 用哪个模型
    api_key="你的密钥",                        # 开门钥匙
    base_url="https://ark.cn-beijing.volces.com/api/v3",  # 地址
)
```

### LangGraph - "流程图画板"

**LangGraph是什么？**

想象你要画一个工作流程图：
```
开始 → 判断问题类型 → 分支1（技术问题） → 结束
                    ↓
                  分支2（订单问题） → 结束
```

LangGraph就是帮你画这种流程图的工具，让多个Agent像流水线一样工作！

---

## 3. 核心框架详解

### 3.1 BaseAgent - "通用员工模板"

**就像公司的通用员工手册：**
- 每个员工都有名字、职位
- 每个员工都能接受任务
- 每个员工都能使用工具

```python
class BaseAgent:
    def __init__(self, name, role, system_prompt, tools=None):
        self.name = name           # 名字：张三
        self.role = role           # 职位：市场分析师
        self.tools = tools or []   # 工具包：计算器、数据库等
```

### 3.2 AgentConfig - "员工配置表"

**就像填入职申请表：**
- 填名字、职位、工作职责
- 配什么工具
- 然后一键生成员工！

```python
# 配置一个法律专家
LEGAL_EXPERT_CONFIG = AgentConfig(
    name="legal_expert",                    # 名字
    role="法律合规专家",                     # 职位
    description="负责合同审查、法律风险评估", # 工作职责
    system_prompt="你是一位资深法律合规专家...", # 工作指南
    tools=[search_legal_knowledge, get_contract_review_template] # 配工具
)

# 一键生成！
legal_agent = LEGAL_EXPERT_CONFIG.create_agent()
```

**关键点：不用写代码，改配置就行！**

### 3.3 CoordinatorAgent - "项目经理"

这是真正的**智能协调**！

- 用大模型**理解**用户需求
- 把复杂任务**分解**成多个子任务
- 为每个子任务**选择**最合适的专家
- 生成**任务分配计划**

### 3.4 AgentOrchestrator - "总监"

管理整个项目流程：
1. 初始化所有专家
2. 让协调员分配任务
3. 让多个专家**同时干活**（并发执行）
4. 汇总结果生成报告

---

## 4. 法律财务专家系统实现

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     用户提出问题                         │
│           "请审查一份供应商合同的关键条款"               │
└────────────────────────────┬────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────┐
│              协调员（前台导诊）                          │
│         分析问题 → 判断类型 → 分配给法律专家            │
└────────────────────────────┬────────────────────────────┘
                             ↓
        ┌────────────────────┼────────────────────┐
        ↓                    ↓                    ↓
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ 法律合规专家  │  │ 财务专家       │  │ （可扩展）     │
│ (合同审查)    │  │ (财务报表)     │  │               │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        ↓                    ↓                    ↓
┌─────────────────────────────────────────────────────────┐
│              调用工具（Skills）                          │
│         从SKILL.md加载专业知识                          │
└────────────────────────────┬────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────┐
│                  大模型生成回答                          │
└─────────────────────────────────────────────────────────┘
```

### 4.2 项目文件结构

```
d:\mycode\Agent-team/
├── agent_framework.py              # 核心框架（BaseAgent、AgentConfig等）
├── skill_loader.py                 # SKILL.md 文件加载器
├── legal_finance_swarm.py          # 协调系统主入口
├── run_legal_finance.py            # 运行入口（保存报告）
├── agents/                         # Agent 模块目录（模块化设计）
│   ├── __init__.py                 # 模块入口
│   ├── legal_agent.py              # 法律专家 Agent 定义
│   └── finance_agent.py            # 财务专家 Agent 定义
├── knowledge-work-plugins/         # Anthropic知识插件库
│   ├── legal/skills/
│   │   ├── contract-review/SKILL.md
│   │   ├── compliance/SKILL.md
│   │   └── ...
│   └── finance/skills/
│       ├── financial-statements/SKILL.md
│       ├── variance-analysis/SKILL.md
│       └── ...
└── tests/                          # 测试文件和生成的报告
    ├── test_legal_finance.py
    └── report_*.txt
```

---

## 5. 模块化Agent架构

### 5.1 为什么模块化？

**之前的问题：**
- 所有Agent定义混在一个文件里
- 工具函数也混在一起
- 不便于管理和扩展

**模块化后的好处：**
- 每个Agent独立文件，职责清晰
- 工具函数和配置放在一起
- 便于团队协作和维护

### 5.2 Agent文件结构

每个Agent文件都遵循统一的结构：

```python
# agents/legal_agent.py

"""
法律合规专家 Agent 定义
基于 BaseAgent 的具体实现
"""
from langchain.tools import tool
from agent_framework import AgentConfig, BaseAgent
from skill_loader import create_skill_loader

# 1. 初始化技能加载器
_skill_loader = create_skill_loader()

# 2. 定义工具函数
@tool
def search_legal_knowledge(topic: str) -> str:
    """搜索法律相关知识"""
    # 优先从 SKILL.md 加载
    content = _get_legal_skill_content("contract-review")
    if content:
        return content
    # 回退到硬编码
    return "备用知识..."

@tool
def get_contract_review_template() -> str:
    """获取合同审查模板"""
    # ...

# 3. 定义Agent配置
LEGAL_EXPERT_CONFIG = AgentConfig(
    name="legal_expert",
    role="法律合规专家",
    description="负责合同审查、法律风险评估...",
    system_prompt="你是一位资深法律合规专家...",
    tools=[search_legal_knowledge, get_contract_review_template]
)

# 4. 创建函数
def create_legal_agent() -> BaseAgent:
    """创建法律合规专家 Agent 实例"""
    return LEGAL_EXPERT_CONFIG.create_agent()
```

### 5.3 模块入口文件

```python
# agents/__init__.py

from .legal_agent import LEGAL_EXPERT_CONFIG, create_legal_agent
from .finance_agent import FINANCE_EXPERT_CONFIG, create_finance_agent

__all__ = [
    'LEGAL_EXPERT_CONFIG',
    'FINANCE_EXPERT_CONFIG',
    'create_legal_agent',
    'create_finance_agent',
]
```

---

## 6. knowledge-work-plugins集成详解

### 6.1 什么是 knowledge-work-plugins？

**用图书馆的例子理解：**

想象你要开一家医院，你需要：
- 📚 **医学百科全书** - 各种疾病的诊断方法
- 📚 **手术操作手册** - 各种手术的标准流程
- 📚 **药品说明书** - 各种药物的用法用量

**knowledge-work-plugins 就是这样的"专业知识图书馆"！**

它是由 Anthropic 公司开源的一个项目，包含了大量专业领域的知识文件，覆盖：

| 领域 | 包含内容 |
|------|----------|
| **法律（legal）** | 合同审查、合规检查、NDA分类、法律风险评估 |
| **财务（finance）** | 财务报表、差异分析、日记账、审计支持 |
| **市场营销（marketing）** | 品牌声音、活动策划、竞争分析、内容创作 |
| **产品管理（product-management）** | 功能规格、路线图、用户研究 |
| **销售（sales）** | 客户研究、电话准备、竞争情报 |
| **数据分析（data）** | SQL查询、统计分析、数据可视化 |
| **生物研究（bio-research）** | 单细胞分析、基因组学、实验流程 |
| ... | 还有更多！ |

### 6.2 knowledge-work-plugins 的目录结构

```
knowledge-work-plugins/
├── legal/                          # 法律领域插件
│   ├── .claude-plugin/
│   │   └── plugin.json             # 插件配置
│   ├── commands/                   # 命令（快捷方式）
│   │   ├── review-contract.md
│   │   ├── triage-nda.md
│   │   └── ...
│   ├── skills/                     # 技能（核心知识）
│   │   ├── contract-review/
│   │   │   └── SKILL.md            # 合同审查知识文件
│   │   ├── compliance/
│   │   │   └── SKILL.md            # 合规检查知识文件
│   │   └── ...
│   └── CONNECTORS.md               # 连接器说明
│
├── finance/                        # 财务领域插件
│   ├── skills/
│   │   ├── financial-statements/
│   │   │   └── SKILL.md            # 财务报表知识文件
│   │   ├── variance-analysis/
│   │   │   └── SKILL.md            # 差异分析知识文件
│   │   └── ...
│   └── ...
│
├── marketing/                      # 市场营销插件
├── sales/                          # 销售插件
├── data/                           # 数据分析插件
└── ...                             # 更多领域
```

### 6.3 SKILL.md 文件的结构

每个 SKILL.md 文件都遵循统一的格式：

```markdown
---
name: contract-review
description: 审查合同，识别偏离，生成修订建议
---

# Contract Review Skill

你是一个合同审查助手...

## Playbook-Based Review Methodology

### 步骤1：识别合同类型
SaaS协议、专业服务、许可证...

### 步骤2：确定用户立场
供应商、客户、许可方、被许可方...

### 步骤3：分析关键条款
- 责任限制条款
- 赔偿条款
- 知识产权条款
...

## Common Clause Analysis

### Limitation of Liability
关键要素：
- 赔偿上限金额
- 是否互惠
- 例外条款...
```

**结构说明：**
1. **YAML Frontmatter** - 元数据（名称、描述）
2. **角色定义** - 这个技能是做什么的
3. **方法论** - 具体的工作流程
4. **详细知识** - 专业领域的具体内容

### 6.4 本项目如何集成 knowledge-work-plugins？

#### 整体思路

```
┌─────────────────────────────────────────────────────────────┐
│                  knowledge-work-plugins                      │
│              （Anthropic开源的专业知识库）                    │
│                                                              │
│  legal/contract-review/SKILL.md                              │
│  legal/compliance/SKILL.md                                   │
│  finance/financial-statements/SKILL.md                       │
│  ...                                                         │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ↓ 加载
┌─────────────────────────────────────────────────────────────┐
│                    skill_loader.py                           │
│                  （我们的知识加载器）                         │
│                                                              │
│  - 扫描所有 SKILL.md 文件                                    │
│  - 解析 YAML frontmatter                                     │
│  - 提取知识内容                                              │
│  - 按 "领域.技能名" 组织                                      │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ↓ 提供
┌─────────────────────────────────────────────────────────────┐
│                    Agent 工具函数                            │
│              （legal_agent.py, finance_agent.py）            │
│                                                              │
│  @tool                                                       │
│  def search_legal_knowledge(topic):                          │
│      skill = _skill_loader.get_skill("legal", "contract-review")│
│      return skill['content']                                 │
└─────────────────────────────────────────────────────────────┘
```

#### 核心代码：skill_loader.py

```python
class SkillLoader:
    """SKILL.md 文件加载器"""
    
    def __init__(self, plugins_dir="knowledge-work-plugins"):
        self.plugins_dir = Path(plugins_dir)
        self.skills = {}
        self._load_all_skills()
    
    def _parse_frontmatter(self, content):
        """解析 YAML frontmatter"""
        # 提取 --- 之间的元数据
        # 返回 (元数据字典, 正文内容)
    
    def _load_skill_file(self, skill_path):
        """加载单个 SKILL.md 文件"""
        # 读取文件
        # 解析 frontmatter
        # 返回技能对象
    
    def _get_category(self, skill_path):
        """根据路径判断技能分类"""
        # legal/skills/... → "legal"
        # finance/skills/... → "finance"
    
    def _load_all_skills(self):
        """加载所有 SKILL.md 文件"""
        # 扫描 knowledge-work-plugins/ 下所有 SKILL.md
        # 按 "领域.技能名" 存储
    
    def get_skill(self, category, name):
        """获取指定技能"""
        return self.skills.get(f"{category}.{name}")
```

#### 在 Agent 中使用

```python
# agents/legal_agent.py

from skill_loader import create_skill_loader

_skill_loader = create_skill_loader()

@tool
def search_legal_knowledge(topic: str) -> str:
    """搜索法律相关知识"""
    
    # 1. 根据主题映射到具体的 SKILL.md
    skill_mapping = {
        "合同审查": "contract-review",
        "合规检查": "compliance",
        "NDA": "nda-triage",
        ...
    }
    
    # 2. 从 knowledge-work-plugins 加载知识
    skill_name = skill_mapping.get(topic)
    if skill_name:
        skill = _skill_loader.get_skill("legal", skill_name)
        if skill:
            return "【从SKILL.md加载】\n" + skill['content']
    
    # 3. 回退到硬编码知识
    return "【备用知识库】\n" + fallback_knowledge
```

### 6.5 专家知识如何组织、扩展和调用？

#### 知识组织方式

```
knowledge-work-plugins/
├── legal/                        # 法律领域
│   └── skills/
│       ├── contract-review/      # 合同审查技能
│       │   └── SKILL.md          # 知识文件（200+行专业知识）
│       ├── compliance/           # 合规检查技能
│       │   └── SKILL.md
│       └── ...
│
├── finance/                      # 财务领域
│   └── skills/
│       ├── financial-statements/ # 财务报表技能
│       │   └── SKILL.md          # 知识文件（GAAP标准、格式模板）
│       └── ...
│
└── [新领域]/                     # 扩展新领域
    └── skills/
        └── [新技能]/
            └── SKILL.md
```

#### 如何扩展新知识？

**方法1：添加新的 SKILL.md 文件**

```bash
# 在 knowledge-work-plugins/ 下创建新的技能目录
mkdir -p knowledge-work-plugins/tax/skills/tax-consultation

# 创建 SKILL.md 文件
# knowledge-work-plugins/tax/skills/tax-consultation/SKILL.md
```

```markdown
---
name: tax-consultation
description: 税务咨询和申报指导
---

# Tax Consultation Skill

你是一个税务咨询助手...

## 税务申报流程

### 增值税申报
...

### 企业所得税申报
...

## 税务筹划建议
...
```

**方法2：修改现有 SKILL.md 文件**

直接编辑 `knowledge-work-plugins/legal/skills/contract-review/SKILL.md`，添加新的条款分析内容。

#### 知识调用流程

```
用户提问: "请审查一份供应商合同"
         ↓
协调员分析: 这是法律问题 → 分配给法律专家
         ↓
法律专家调用工具: search_legal_knowledge("合同审查")
         ↓
工具函数执行:
  1. 映射主题: "合同审查" → "contract-review"
  2. 加载知识: _skill_loader.get_skill("legal", "contract-review")
  3. 返回内容: SKILL.md 的完整内容
         ↓
大模型结合知识生成回答
         ↓
返回给用户
```

### 6.6 当前集成的技能列表

系统启动时会自动加载 **52个专业技能**：

**法律类（6个）：**
| 技能名 | 描述 |
|--------|------|
| contract-review | 合同审查，识别偏离，生成修订建议 |
| compliance | 合规检查，GDPR、CCPA等法规 |
| nda-triage | NDA分类和处理 |
| legal-risk-assessment | 法律风险评估 |
| meeting-briefing | 会议简报准备 |
| canned-responses | 模板化响应 |

**财务类（6个）：**
| 技能名 | 描述 |
|--------|------|
| financial-statements | 财务报表生成（利润表、资产负债表、现金流量表） |
| variance-analysis | 差异分析（预算vs实际） |
| journal-entry-prep | 日记账准备 |
| reconciliation | 账户对账 |
| close-management | 月末结账管理 |
| audit-support | 审计支持（SOX合规） |

**其他领域（40个）：**
- 市场营销：品牌声音、活动策划、竞争分析、内容创作
- 产品管理：功能规格、路线图管理、用户研究
- 销售支持：客户研究、电话准备、竞争情报
- 数据分析：SQL查询、统计分析、数据可视化
- 生物研究：单细胞分析、基因组学、实验流程
- ...更多

### 6.7 集成的优势

| 优势 | 说明 |
|------|------|
| **专业知识库** | 直接使用 Anthropic 精心编写的专业知识 |
| **持续更新** | knowledge-work-plugins 持续更新，我们自动获得新知识 |
| **标准化格式** | 所有知识文件格式统一，便于解析和使用 |
| **领域覆盖广** | 法律、财务、营销、销售、数据等多个领域 |
| **易于扩展** | 添加新技能只需创建新的 SKILL.md 文件 |

---

## 7. SKILL.md知识加载机制

### 7.1 什么是SKILL.md？

SKILL.md 是一种**结构化的知识文件格式**，用于存储专业知识：

```markdown
---
name: contract-review
description: 合同审查技能
---

# 合同审查方法论

## Playbook-Based Review

### 步骤1：合同类型识别
...

### 步骤2：关键条款分析
- 责任限制条款
- 赔偿条款
- 知识产权条款
...
```

### 7.2 SkillLoader 加载器

`skill_loader.py` 负责加载所有 SKILL.md 文件：

```python
class SkillLoader:
    def __init__(self, plugins_dir="knowledge-work-plugins"):
        self.plugins_dir = Path(plugins_dir)
        self.skills = {}
        self._load_all_skills()
    
    def _load_all_skills(self):
        """扫描并加载所有 SKILL.md 文件"""
        skill_files = list(self.plugins_dir.rglob("SKILL.md"))
        for skill_path in skill_files:
            skill = self._load_skill_file(skill_path)
            if skill:
                skill_key = skill['category'] + "." + skill['name']
                self.skills[skill_key] = skill
    
    def get_skill(self, category, name):
        """获取指定技能"""
        return self.skills.get(f"{category}.{name}")
```

### 7.3 知识优先级

工具函数采用**双重知识源**策略：

1. **优先**：从 SKILL.md 文件加载（专业知识库）
2. **回退**：使用硬编码知识（备用）

```python
@tool
def search_legal_knowledge(topic: str) -> str:
    # 1. 尝试从 SKILL.md 获取
    content = _get_legal_skill_content(skill_name)
    if content:
        return "【从SKILL.md加载】\n" + content
    
    # 2. 回退到硬编码
    return "【备用知识库】\n" + fallback_knowledge
```

---

## 8. 如何扩展新专家

### 想加一个"税务专家"？只需3步！

#### 第1步：创建Agent文件

在 `agents/` 目录下创建 `tax_agent.py`：

```python
# agents/tax_agent.py

from langchain.tools import tool
from agent_framework import AgentConfig, BaseAgent
from skill_loader import create_skill_loader

_skill_loader = create_skill_loader()

@tool
def search_tax_knowledge(topic: str) -> str:
    """搜索税务相关知识"""
    skill = _skill_loader.get_skill("tax", "tax-consultation")
    if skill:
        return skill['content']
    return "备用税务知识..."

@tool
def get_tax_declaration_template() -> str:
    """获取税务申报模板"""
    # ...

TAX_EXPERT_CONFIG = AgentConfig(
    name="tax_expert",
    role="税务专家",
    description="负责税务咨询、申报指导",
    system_prompt="你是一位资深税务专家...",
    tools=[search_tax_knowledge, get_tax_declaration_template]
)

def create_tax_agent() -> BaseAgent:
    return TAX_EXPERT_CONFIG.create_agent()
```

#### 第2步：更新模块入口

在 `agents/__init__.py` 中添加：

```python
from .tax_agent import TAX_EXPERT_CONFIG, create_tax_agent

__all__ = [
    # ... 原有的
    'TAX_EXPERT_CONFIG',
    'create_tax_agent',
]
```

#### 第3步：更新协调系统

在 `legal_finance_swarm.py` 中导入并添加配置：

```python
from agents import LEGAL_EXPERT_CONFIG, FINANCE_EXPERT_CONFIG, TAX_EXPERT_CONFIG

def create_expert_configs():
    return {
        LEGAL_EXPERT_CONFIG.name: LEGAL_EXPERT_CONFIG,
        FINANCE_EXPERT_CONFIG.name: FINANCE_EXPERT_CONFIG,
        TAX_EXPERT_CONFIG.name: TAX_EXPERT_CONFIG,  # 新加！
    }
```

**就这么简单！协调员会自动识别税务问题，分配给税务专家！**

---

## 9. 运行指南

### 9.1 运行测试

```bash
python tests\test_legal_finance.py
```

### 9.2 运行完整流程并保存报告

```bash
python run_legal_finance.py
```

### 9.3 查看生成的报告

在 `tests` 目录下，会有类似这样的文件：
- `report_1_20260222_152710.txt` - 法律专家报告
- `report_2_20260222_152710.txt` - 财务专家报告

### 9.4 运行交互式版本

```bash
python legal_finance_swarm.py
```

然后输入你的问题，系统会自动分配给合适的专家处理。

---

## 总结

### 我们实现了什么？

| 特性 | 说明 |
|------|------|
| **通用Agent框架** | BaseAgent基类，AgentConfig配置化 |
| **智能协调** | CoordinatorAgent用大模型理解和分配任务 |
| **模块化设计** | 每个Agent独立文件，便于管理 |
| **knowledge-work-plugins集成** | 直接使用Anthropic开源的专业知识库 |
| **SKILL.md知识加载** | 从专业知识库加载，硬编码作为备用 |
| **并发执行** | 多个专家同时工作，效率高 |
| **完整报告保存** | 带时间戳保存到文件 |

### 核心思想

1. **配置代替硬编码** - 改配置就行，不用改代码
2. **大模型智能协调** - 不是简单的关键词匹配
3. **模块化设计** - 加新专家只需加一个文件
4. **知识分离** - 专业知识放在 knowledge-work-plugins，代码只管逻辑
5. **开源复用** - 直接使用 Anthropic 的专业知识库，避免重复造轮子

---

**文档版本：** v3.0  
**最后更新：** 2026-02-22
