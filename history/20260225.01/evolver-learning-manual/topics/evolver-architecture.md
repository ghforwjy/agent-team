# Evolver 架构解析

> 从 MCP 接口到 GEP 基因引擎的完整架构理解

---

## 核心概念

Evolver 采用**分层架构设计**，包含两个主要层次：

1. **MCP 层 (Model Context Protocol)** - 对外接口层
2. **GEP 层 (Gene Evolution Protocol)** - 内部基因引擎层

---

## 详细解释

### MCP 层 - 对外接口

MCP 层提供 4 个标准化工具接口，供外部调用：

| 工具名 | 功能 | 使用场景 |
|--------|------|----------|
| `analyze_session` | 分析会话历史 | 每次任务完成后自动调用 |
| `suggest_improvement` | 获取改进建议 | 遇到问题时调用 |
| `get_best_practice` | 查询最佳实践 | 需要参考标准方案时调用 |
| `evolve_capability` | 执行进化循环 | 需要系统性改进时调用 |

**特点**：
- 标准化接口，与具体实现解耦
- 通过 `mcp-server.js` 提供服务
- 配置在 `.trae/evolver-agent.json` 中

### GEP 层 - 基因引擎

GEP 层是 Evolver 的核心进化引擎，包含**基因库**和**知识胶囊**：

#### 基因 (Gene)

基因是 Evolver 的**行为模式定义**，决定如何响应不同信号：

| 基因ID | 类别 | 功能 |
|--------|------|------|
| `gene_gep_repair_from_errors` | 🔧 repair | 从错误中学习修复 |
| `gene_gep_optimize_prompt_and_assets` | ⚡ optimize | 优化提示词和资源 |
| `gene_gep_innovate_from_opportunity` | 🚀 innovate | 从机会中创新 |
| `gene_knowledge_accumulation` | 📚 innovate | 知识积累与总结 |

**基因结构**：
```json
{
  "type": "Gene",
  "id": "gene_xxx",
  "category": "repair|optimize|innovate",
  "signals_match": ["触发信号列表"],
  "preconditions": ["前置条件"],
  "strategy": ["执行策略步骤"],
  "constraints": { "约束条件" },
  "validation": ["验证步骤"]
}
```

#### 知识胶囊 (Capsule)

胶囊是**成功经验的具体记录**，可被复用：

```json
{
  "type": "Capsule",
  "id": "capsule_xxx",
  "trigger": ["触发信号"],
  "gene": "来源基因",
  "summary": "经验总结",
  "confidence": 0.85,
  "blast_radius": { "files": 1, "lines": 2 },
  "outcome": { "status": "success", "score": 0.85 }
}
```

### 架构关系图

```
┌─────────────────────────────────────────────────────────┐
│                      用户交互层                          │
│                   (User Interface)                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    MCP 接口层                            │
│  ┌──────────────┬──────────────┬──────────────┐         │
│  │   analyze    │   suggest    │    evolve    │  get   │
│  │   _session   │  _improvement │  _capability │_best_practice
│  └──────────────┴──────────────┴──────────────┘         │
│              (mcp-server.js)                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    GEP 基因引擎层                        │
│  ┌─────────────────────────────────────────────────┐    │
│  │                   基因库                          │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐        │    │
│  │  │  repair  │ │ optimize │ │ innovate │        │    │
│  │  │   基因   │ │   基因   │ │   基因   │        │    │
│  │  └──────────┘ └──────────┘ └──────────┘        │    │
│  └─────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────┐    │
│  │                 知识胶囊库                        │    │
│  │       (成功经验的固化记录，可复用)                  │    │
│  └─────────────────────────────────────────────────┘    │
│              (assets/gep/)                               │
└─────────────────────────────────────────────────────────┘
```

---

## 类比理解

### 生物进化类比

| 生物进化 | Evolver 架构 | 说明 |
|----------|--------------|------|
| **DNA** | **Gene (基因)** | 遗传信息，决定行为模式 |
| **蛋白质** | **Capsule (胶囊)** | 基因表达的结果，具体功能实现 |
| **神经系统** | **MCP 层** | 对外感知和响应的接口 |
| **细胞核** | **GEP 层** | 存储和处理遗传信息的核心 |
| **自然选择** | **Signal 匹配** | 环境信号触发相应基因表达 |

### 软件架构类比

| 传统软件 | Evolver 架构 | 说明 |
|----------|--------------|------|
| **API 接口** | **MCP 工具** | 对外暴露的能力接口 |
| **业务逻辑** | **Gene 策略** | 处理不同场景的核心逻辑 |
| **缓存/经验** | **Capsule** | 存储成功经验，加速后续处理 |
| **配置文件** | **genes.json** | 定义系统行为的配置 |

---

## 实际示例

### 场景：用户报告代码错误

**信号流**：
```
用户: "代码运行报错了"
  ↓
MCP层: analyze_session 被调用
  ↓
GEP层: 提取信号 ["error", "runtime_error"]
  ↓
Selector: 匹配 gene_gep_repair_from_errors
  ↓
执行策略:
  1. 提取错误信号
  2. 估算影响范围
  3. 应用最小补丁
  4. 验证修复
  5. 固化到 Capsule
```

### 场景：用户询问架构问题

**信号流**：
```
用户: "你现在拥有哪些evolver基因"
  ↓
MCP层: 对话交互
  ↓
GEP层: 提取信号 ["knowledge_question", "concept_explanation"]
  ↓
Selector: 匹配 gene_knowledge_accumulation
  ↓
执行策略:
  1. 深入解释概念
  2. 创建知识文档
  3. 更新索引
  4. 生成知识胶囊
```

---

## 常见误区

### ❌ 误区 1：MCP 工具 = 基因

**错误理解**：认为 `analyze_session` 等 4 个工具就是基因。

**正确理解**：MCP 工具是**调用接口**，基因是**内部实现逻辑**。一个 MCP 工具可能触发多个基因。

### ❌ 误区 2：基因越多越好

**错误理解**：认为基因数量越多越好。

**正确理解**：基因应该**精简且正交**，每个基因解决一类问题。过多基因会导致选择困难。

### ❌ 误区 3：胶囊只是日志

**错误理解**：认为胶囊只是操作日志。

**正确理解**：胶囊是**可复用的经验模式**，包含触发条件、执行策略、验证结果，可被其他场景引用。

---

## 相关话题

- [Gene 与 Capsule](./gene-and-capsule.md) - 核心概念详解
- [匹配机制](./matching-mechanism.md) - 基因如何选择和匹配

---

## 参考链接

- [Evolver GEP 规范](../../evolver/README.zh-CN.md)
- [基因定义文件](../../evolver/assets/gep/genes.json)
- [胶囊存储](../../evolver/assets/gep/capsules.json)
- [知识积累基因定义](../../evolver/assets/gep/genes/gene_knowledge_accumulation.json)

---

*本话题由 Evolver 知识积累基因驱动生成*
*创建时间: 2026-02-24*
