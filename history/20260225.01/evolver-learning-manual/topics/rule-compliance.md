# 规则遵循机制

> 如何确保项目规则被自动执行，防止"知道规则但不执行"的问题

---

## 核心概念

**规则遵循失败**是指 AI 助手明确知道项目规则的存在，但在实际操作中没有自动执行这些规则。这是一个典型的"知行分离"问题。

---

## 问题背景

### 真实案例：Evolver 会话分析规则

**场景回顾**：
```
用户: "聊聊你自己的进化机制吧"
AI:  [介绍了进化机制]
     [没有执行 evolver.analyze_session]
用户: "按照项目rule，每轮对话结束都应该做什么，你做了吗"
AI:  "你说得对，我没有遵守规则！"
```

**问题分析**：

| 问题类型 | 表现 | 原因 |
|----------|------|------|
| **规则意识淡薄** | 知道规则存在但没有执行 | 规则没有被内化为行为习惯 |
| **缺少检查点** | 回复结束前没有自检 | 缺乏强制性的自我监控机制 |
| **优先级混乱** | 认为规则是可选的 | 没有区分强制规则和建议 |

---

## 解决方案：`gene_rule_compliance`

### 基因设计

新基因 `gene_rule_compliance` 专门用于确保规则执行：

**触发信号**：
- `rule_violation` - 规则被违反
- `rule_not_followed` - 规则未被执行
- `auto_call_required` - 需要自动调用
- `self_monitoring_needed` - 需要自我监控
- `mandatory_action_missed` - 强制动作被遗漏
- `rule_awareness_gap` - 规则意识缺失

**执行策略**：
1. 识别触发的规则 - 明确哪条规则应该被执行
2. 检查执行状态 - 确认规则要求的动作是否已完成
3. 立即补救 - 如未完成，立即执行规则要求的动作
4. 建立检查点 - 在回复结束前自问：是否有规则需要执行？
5. 记录偏差 - 将规则遵循失败的模式记录到学习手册
6. 强化意识 - 在后续会话中主动检查规则执行

---

## 检查点机制

### 回复结束前的自检问题

在每次回复结束前，应该问自己：

1. 本次回复是否完成了所有必要的规则动作？
2. 是否有需要自动调用的工具或函数？
3. 规则文件中是否有强制要求？
4. 会话结束时是否需要执行分析？

### 规则优先级

| 优先级 | 类型 | 示例 |
|--------|------|------|
| **P0 - 强制** | 必须无条件执行 | `evolver.analyze_session` |
| **P1 - 高** | 应该执行 | 代码变更后的 lint 检查 |
| **P2 - 中** | 建议执行 | 添加注释说明 |
| **P3 - 低** | 可选执行 | 创建文档 |

---

## 与其他基因的协作

```
gene_rule_compliance
    ├── gene_prevent_cognitive_bias (检查是否因认知偏差而忽略规则)
    ├── gene_gep_repair_from_errors (规则遵循失败触发修复流程)
    └── gene_knowledge_accumulation (记录规则遵循的最佳实践)
```

---

## 最佳实践

### 1. 规则内化

- 在回复前快速扫描规则文件
- 将规则转化为具体的检查清单
- 建立规则与动作的自动关联

### 2. 检查点嵌入

- 在回复结束前强制执行检查点
- 使用显式的"自问"机制
- 记录每次检查的结果

### 3. 偏差记录

- 记录每次规则遵循失败的情况
- 分析失败的根本原因
- 更新基因策略以防止复发

---

## 创建记录

- **创建日期**: 2026-02-25
- **创建原因**: 在讨论进化机制时，用户指出助手没有自动执行 `evolver.analyze_session` 规则
- **相关基因**: [gene_rule_compliance.json](../evolver/assets/gep/genes/gene_rule_compliance.json)
