# 模块2 - 读取审计项要求详细设计

## 目标
从审计项中提取制度要求，使用大模型批量处理。

---

## 一、处理策略

**完全使用大模型批量处理**

- 每批处理100个审计项
- 大模型一次性分析整批数据
- 按制度要求维度输出提取结果
- 记录完整的溯源信息

---

## 二、批次设计

### 2.1 批次划分

```
总审计项: 293条
批次大小: 100条
批次数量: 3批

批次1: 审计项 1-100
批次2: 审计项 101-200
批次3: 审计项 201-293
```

### 2.2 批次号生成

```python
def generate_batch_id() -> str:
    """生成批次号: POLICY-YYYYMMDD-NNN-XXX"""
    from datetime import datetime
    import uuid
    
    date_str = datetime.now().strftime("%Y%m%d")
    short_uuid = uuid.uuid4().hex[:6].upper()
    return f"POLICY-{date_str}-{short_uuid}"

# 示例: POLICY-20260227-A3B5C9
```

---

## 三、LLM批量处理提示词

### 3.1 系统提示词

```
你是一个IT审计专家，擅长从审计程序中提取制度建设要求。

你的任务是分析一批审计项，识别其中包含的制度建设要求。

制度建设要求包括：
1. 建立制度：需要制定什么制度、方案、办法、流程
2. 建立组织：需要设立什么委员会、部门、岗位
3. 人员配备：需要配备什么人员、数量要求、资格要求
4. 定期执行：需要定期做什么工作、频率要求
5. 岗位分离：关键岗位分离、主备岗要求
6. 文件保存：文件保存时限要求

请按制度要求维度组织输出结果。
```

### 3.2 用户提示词模板

```
请分析以下审计项批次，提取其中的制度建设要求。

【批次信息】
- 批次号: {batch_id}
- 审计项数量: {item_count}
- 提取时间: {extract_time}

【审计项列表】
{audit_items}

请按以下JSON格式输出分析结果：

{{
  "batch_id": "批次号",
  "extract_time": "提取时间ISO格式",
  "total_items": 100,
  "policy_requirements": [
    {{
      "requirement_id": "REQ-001",  // 要求编号，本批次内唯一
      "source_item_code": "审计项编码",
      "source_item_title": "审计项标题",
      "source_procedure": "来源的审计程序内容",
      "requirement_type": "建立制度/建立组织/人员配备/定期执行/岗位分离/文件保存",
      "requirement_detail": {{
        "what": "要求建立什么",
        "scope": "适用范围",
        "content": "具体要求内容",
        "frequency": "执行频率（定期执行类）",
        "quantity": "数量要求（人员配备类）",
        "qualification": "资格要求（人员配备类）",
        "retention_period": "保存期限（文件保存类）"
      }},
      "related_clues": ["关键词1", "关键词2", "关键词3"],
      "confidence": 0.95  // 置信度0-1
    }}
  ],
  "statistics": {{
    "total_requirements": 30,
    "by_type": {{
      "建立制度": 12,
      "建立组织": 3,
      "人员配备": 5,
      "定期执行": 8,
      "岗位分离": 1,
      "文件保存": 1
    }}
  }}
}}

注意：
1. 只输出包含制度建设要求的审计项
2. 如果一个审计项包含多个制度要求，请分别列出
3. related_clues用于后续匹配制度文档，请提取3-5个关键词
4. confidence表示你对此提取结果的置信度
5. 请确保JSON格式正确
```

### 3.3 审计项列表格式

```
【审计项1】
编码: NEW-20260227112113-M001
维度: XC建党100周年网络安全保障专项
标题: 是否制定相关的网络安全保障方案
程序: 检查公司是否制定专门的建党100年网络安全保障方案。检查方案是否包含工作目标、组织保障、工作机制、工作计划、工作要求等内容。

【审计项2】
编码: NEW-20260227112113-M004
维度: XC信息技术治理
标题: 公司是否建立IT治理委员会
程序: 查阅IT治理委员会成立发文。检查委员会是否由公司主要负责人、相关高级管理人员及相关部门负责人组成。

...
```

---

## 四、输出数据结构

### 4.1 单条提取结果

```json
{
  "requirement_id": "REQ-001",
  "batch_id": "POLICY-20260227-A3B5C9",
  "batch_seq": 1,
  "extract_time": "2024-02-27T10:30:00+08:00",
  "source": {
    "item_code": "NEW-20260227112113-M001",
    "item_title": "是否制定相关的网络安全保障方案",
    "dimension": "XC建党100周年网络安全保障专项",
    "procedure": "检查公司是否制定专门的建党100年网络安全保障方案..."
  },
  "requirement_type": "建立制度",
  "requirement_detail": {
    "what": "建党100年网络安全保障方案",
    "scope": "公司网络安全保障",
    "content": "方案应包含工作目标、组织保障、工作机制、工作计划、工作要求等内容",
    "frequency": null,
    "quantity": null,
    "qualification": null,
    "retention_period": null
  },
  "related_clues": ["网络安全保障", "建党100年", "保障方案"],
  "confidence": 0.95
}
```

### 4.2 完整输出文件

```json
{
  "version": "1.0",
  "batch_info": {
    "batch_id": "POLICY-20260227-A3B5C9",
    "extract_time": "2024-02-27T10:30:00+08:00",
    "total_batches": 3,
    "current_batch": 1,
    "items_in_batch": 100
  },
  "summary": {
    "total_items_processed": 100,
    "total_requirements_found": 30,
    "by_type": {
      "建立制度": 12,
      "建立组织": 3,
      "人员配备": 5,
      "定期执行": 8,
      "岗位分离": 1,
      "文件保存": 1
    }
  },
  "requirements": [
    // 提取结果列表
  ]
}
```

---

## 五、处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    审计项制度要求提取流程                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 生成批次号                                                    │
│     └── batch_id = POLICY-YYYYMMDD-UUID                          │
│                                                                 │
│  2. 读取审计项                                                    │
│     ├── 连接数据库                                                │
│     ├── 读取所有293条审计项                                       │
│     └── 按100条划分为3批                                          │
│                                                                 │
│  3. 批次处理（循环）                                              │
│     ├── 准备批次数据（100条审计项）                               │
│     ├── 调用LLM批量提取                                           │
│     ├── 解析JSON结果                                              │
│     └── 保存批次结果文件                                          │
│         └── policy_req_{batch_id}_batch{N}.json                   │
│                                                                 │
│  4. 合并结果                                                      │
│     ├── 读取所有批次结果文件                                      │
│     ├── 合并为完整结果                                            │
│     └── 保存总结果文件                                            │
│         └── policy_req_{batch_id}_all.json                        │
│                                                                 │
│  5. 生成报告                                                      │
│     ├── 统计各类制度要求数量                                      │
│     ├── 生成提取报告                                              │
│     └── 保存报告文件                                              │
│         └── policy_req_{batch_id}_report.md                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、代码设计

### 6.1 核心类

```python
class PolicyRequirementExtractor:
    """制度要求提取器"""
    
    def __init__(self, db_path: str, llm_client):
        self.db_path = db_path
        self.llm = llm_client
        self.batch_id = self._generate_batch_id()
        self.batch_size = 100
    
    def extract(self) -> str:
        """
        执行提取流程
        
        Returns:
            总结果文件路径
        """
        # 1. 读取审计项
        audit_items = self._load_audit_items()
        
        # 2. 分批处理
        batches = self._split_batches(audit_items)
        batch_results = []
        
        for i, batch in enumerate(batches, 1):
            result = self._process_batch(batch, i)
            batch_results.append(result)
        
        # 3. 合并结果
        final_result = self._merge_results(batch_results)
        
        # 4. 保存结果
        output_path = self._save_results(final_result)
        
        return output_path
    
    def _generate_batch_id(self) -> str:
        """生成批次号"""
        from datetime import datetime
        import uuid
        date_str = datetime.now().strftime("%Y%m%d")
        short_uuid = uuid.uuid4().hex[:6].upper()
        return f"POLICY-{date_str}-{short_uuid}"
    
    def _load_audit_items(self) -> List[Dict]:
        """从数据库加载审计项"""
        pass
    
    def _split_batches(self, items: List[Dict]) -> List[List[Dict]]:
        """将审计项分批"""
        pass
    
    def _process_batch(self, batch: List[Dict], batch_num: int) -> Dict:
        """处理单个批次"""
        # 1. 构建提示词
        prompt = self._build_prompt(batch, batch_num)
        
        # 2. 调用LLM
        response = self.llm.chat(prompt)
        
        # 3. 解析结果
        result = self._parse_response(response)
        
        # 4. 保存批次结果
        self._save_batch_result(result, batch_num)
        
        return result
    
    def _build_prompt(self, batch: List[Dict], batch_num: int) -> str:
        """构建LLM提示词"""
        pass
    
    def _parse_response(self, response: str) -> Dict:
        """解析LLM响应"""
        pass
    
    def _merge_results(self, batch_results: List[Dict]) -> Dict:
        """合并批次结果"""
        pass
    
    def _save_results(self, result: Dict) -> str:
        """保存最终结果"""
        pass
```

### 6.2 数据类

```python
from dataclasses import dataclass
from typing import List, Optional
from datetime import datetime

@dataclass
class PolicyRequirement:
    """制度要求"""
    requirement_id: str
    batch_id: str
    batch_seq: int
    extract_time: datetime
    source_item_code: str
    source_item_title: str
    source_dimension: str
    source_procedure: str
    requirement_type: str
    what: str
    scope: Optional[str]
    content: str
    frequency: Optional[str]
    quantity: Optional[str]
    qualification: Optional[str]
    retention_period: Optional[str]
    related_clues: List[str]
    confidence: float
```

---

## 七、测试场景

### 测试1：批次号生成

**目标**：验证批次号格式正确

**测试**：
```python
extractor = PolicyRequirementExtractor(db_path, llm_client)
batch_id = extractor.batch_id
```

**预期**：
- 格式：POLICY-YYYYMMDD-XXXXXX
- 长度：24字符

### 测试2：批次划分

**目标**：验证293条审计项正确划分为3批

**测试**：
```python
items = extractor._load_audit_items()
batches = extractor._split_batches(items)
```

**预期**：
- batches长度：3
- batches[0]长度：100
- batches[1]长度：100
- batches[2]长度：93

### 测试3：提示词构建

**目标**：验证提示词包含所有必要信息

**测试**：
```python
prompt = extractor._build_prompt(batch, 1)
```

**预期**：
- 包含批次号
- 包含审计项列表
- 包含输出格式说明

### 测试4：结果解析

**目标**：验证能正确解析LLM返回的JSON

**测试**：
```python
mock_response = '{"batch_id": "...", "requirements": [...]}'
result = extractor._parse_response(mock_response)
```

**预期**：
- 返回Dict类型
- 包含requirements列表

### 测试5：结果合并

**目标**：验证3个批次结果正确合并

**测试**：
```python
final = extractor._merge_results([result1, result2, result3])
```

**预期**：
- 包含所有批次的要求
- 统计信息正确

### 测试6：完整流程

**目标**：验证端到端流程正常

**测试**：
```python
output_path = extractor.extract()
```

**预期**：
- 返回有效文件路径
- 文件存在且非空
- JSON格式正确

---

## 八、文件输出规范

### 8.1 输出目录结构

```
results/
├── policy_req_{batch_id}_batch1.json    # 批次1结果
├── policy_req_{batch_id}_batch2.json    # 批次2结果
├── policy_req_{batch_id}_batch3.json    # 批次3结果
├── policy_req_{batch_id}_all.json       # 合并结果
└── policy_req_{batch_id}_report.md      # 提取报告
```

### 8.2 报告模板

```markdown
# 制度要求提取报告

## 批次信息
- 批次号: {batch_id}
- 提取时间: {extract_time}
- 审计项总数: 293
- 处理批次: 3

## 统计概览
- 发现制度要求: {total_requirements} 条
- 建立制度: {建立制度} 条
- 建立组织: {建立组织} 条
- 人员配备: {人员配备} 条
- 定期执行: {定期执行} 条
- 岗位分离: {岗位分离} 条
- 文件保存: {文件保存} 条

## 详细清单

### 建立制度 ({建立制度}条)

1. **{what}**
   - 来源: {source_item_code} - {source_item_title}
   - 要求: {content}
   - 置信度: {confidence}

...

### 建立组织 ({建立组织}条)
...

## 输出文件
- 完整结果: policy_req_{batch_id}_all.json
- 批次1: policy_req_{batch_id}_batch1.json
- 批次2: policy_req_{batch_id}_batch2.json
- 批次3: policy_req_{batch_id}_batch3.json
```
