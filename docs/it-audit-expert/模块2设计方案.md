# 模块2：制度完备性检查器 - 设计方案

> 创建时间：2026-02-27
> 设计目标：根据审计项要求，检查制度完备性并给出精确调整建议

---

## 一、三个核心设计目标

### 目标1：发现制度与审计项不符合的地方
- 识别现有制度条款与审计要求之间的差距
- 判断制度条款是否满足审计程序的具体要求

### 目标2：检查制度是否涵盖了审计项对制度建设的要求
- 验证每个审计项是否有对应的制度支撑
- 统计制度覆盖度，发现制度缺失领域

### 目标3：给出制度调整意见，精确到
- **什么制度** - 具体制度名称
- **什么条款** - 具体条款编号和位置
- **依据什么** - 对应的审计程序原文
- **做什么调整** - 具体的修改建议和内容

---

## 二、核心流程设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    制度完备性检查流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 读取审计项要求                                               │
│     ├── 从数据库读取所有审计项                                    │
│     ├── 提取审计程序中的制度要求                                  │
│     └── 按维度分类整理                                           │
│                                                                 │
│  2. 解析制度文档                                                 │
│     ├── 扫描制度文件夹                                           │
│     ├── 识别文档格式(Word/PDF/Excel)                              │
│     ├── 提取制度结构(章节/条款)                                   │
│     └── 建立制度条款索引                                         │
│                                                                 │
│  3. 智能匹配分析                                                 │
│     ├── 对每个审计项，向量检索Top-10候选条款                      │
│     ├── 关键词匹配补充检索                                        │
│     ├── LLM单条深度分析匹配程度                                   │
│     │   ├── 直接匹配: 条款完全满足要求                            │
│     │   ├── 部分匹配: 条款部分满足，需完善                        │
│     │   ├── 间接匹配: 通过其他条款间接满足                        │
│     │   └── 无匹配: 制度缺失                                     │
│     └── 记录匹配结果和差距分析                                    │
│                                                                 │
│  4. 生成检查报告                                                 │
│     ├── 统计总体符合度                                           │
│     ├── 列出不符合项(精确到条款)                                  │
│     ├── 列出缺失制度                                             │
│     └── 生成调整建议(含具体条款内容)                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、技术方案

| 组件 | 技术选型 | 理由 |
|------|----------|------|
| **制度解析** | `python-docx` + `pdfplumber` | docx处理Word，pdfplumber处理PDF（比PyPDF2更稳定） |
| **条款检索** | `sentence-transformers` + FAISS | 本地向量检索，快速找到候选条款 |
| **LLM分析** | 豆包API | 单条深度分析，确保输出质量 |
| **报告生成** | `python-docx` | 直接生成可编辑的Word修订建议书 |

---

## 四、数据库表结构

```sql
-- 制度文档表
policy_documents (
    id INTEGER PRIMARY KEY,
    doc_code TEXT UNIQUE,           -- 制度编码
    doc_name TEXT,                  -- 制度名称
    doc_version TEXT,               -- 版本号
    file_path TEXT,                 -- 文件路径
    effective_date DATE,            -- 生效日期
    status TEXT                     -- 有效/废止/修订中
);

-- 制度条款表
policy_clauses (
    id INTEGER PRIMARY KEY,
    doc_id INTEGER,                 -- 关联制度
    clause_number TEXT,             -- 条款编号(如"第5条"、"5.2")
    clause_title TEXT,              -- 条款标题
    clause_content TEXT,            -- 条款内容
    clause_vector BLOB,             -- 向量表示(用于检索)
    keywords TEXT                   -- 关键词
);

-- 审计项-制度映射表
audit_item_policy_mapping (
    id INTEGER PRIMARY KEY,
    item_id INTEGER,                -- 审计项ID
    clause_id INTEGER,              -- 制度条款ID
    match_type TEXT,                -- direct/partial/indirect/none
    match_score REAL,               -- 匹配分数0-100
    gaps TEXT,                      -- 差距描述(JSON)
    recommendation TEXT,            -- 调整建议
    suggested_content TEXT          -- 建议的条款内容
);

-- 制度差距表
policy_gaps (
    id INTEGER PRIMARY KEY,
    item_id INTEGER,                -- 审计项ID
    gap_type TEXT,                  -- 缺失/不完善/不符合
    severity TEXT,                  -- 高/中/低
    description TEXT,               -- 差距描述
    target_policy TEXT,             -- 目标制度
    target_clause TEXT,             -- 目标条款位置
    suggested_content TEXT          -- 建议内容
);
```

---

## 五、核心类设计

```python
# 1. PolicyParser - 制度解析器
class PolicyParser:
    def parse(self, file_path: str) -> PolicyDocument
    def extract_clauses(self, doc: PolicyDocument) -> List[Clause]

# 2. ClauseIndexer - 条款索引器
class ClauseIndexer:
    def build_index(self, clauses: List[Clause]) -> FAISS.Index
    def search(self, query: str, top_k: int = 10) -> List[Clause]
    def keyword_search(self, keywords: List[str]) -> List[Clause]

# 3. ComplianceChecker - 完备性检查器
class ComplianceChecker:
    def check(self, audit_items: List[AuditItem]) -> CheckResult
    def _analyze_single_item(self, item: AuditItem, candidates: List[Clause]) -> Mapping

# 4. LLMAnalyzer - LLM分析器
class LLMAnalyzer:
    def analyze_match(self, item: AuditItem, clauses: List[Clause]) -> AnalysisResult
    def generate_recommendation(self, gap: Gap) -> Recommendation

# 5. ReportGenerator - 报告生成器
class ReportGenerator:
    def generate_json(self, result: CheckResult) -> str
    def generate_word(self, result: CheckResult) -> str
```

---

## 六、LLM输出结构

```json
{
  "audit_item": "审计项标题",
  "audit_procedure": "审计程序要求",
  "matched_clauses": [
    {
      "clause_id": "条款ID",
      "clause_number": "第5条",
      "clause_title": "访问控制",
      "match_type": "direct|partial|indirect|none",
      "match_score": 85,
      "analysis": "匹配分析说明"
    }
  ],
  "gap_analysis": {
    "has_gap": true,
    "gap_type": "缺失|不完善|不符合",
    "current_status": "制度现状描述",
    "requirement": "审计程序原文引用"
  },
  "recommendation": {
    "target_policy": "目标制度名称",
    "target_clause": "目标条款位置",
    "action": "新增|修订|删除",
    "suggested_content": "具体的条款内容建议"
  }
}
```

---

## 七、文件结构

```
2-policy-compliance-checker/
├── SKILL.md                          # 模块功能说明
├── scripts/
│   ├── __init__.py
│   ├── checker.py                    # 主程序入口
│   ├── policy_parser.py              # 制度解析器
│   ├── clause_indexer.py             # 条款索引器
│   ├── compliance_checker.py         # 完备性检查器
│   ├── llm_analyzer.py               # LLM分析器
│   └── report_generator.py           # 报告生成器
└── references/
    └── policy-standards.md           # 制度编写规范参考
```

---

## 八、待讨论问题

1. **向量检索召回率**：Top-10是否足够？是否需要混合检索策略？
2. **LLM调用成本**：单条分析成本较高，是否有优化空间？
3. **制度条款提取**：如何处理不同格式的制度文档？
4. **匹配粒度**：是否支持一个审计项匹配多个制度条款？

---

## 九、命令行使用

```bash
# 检查制度完备性
python knowledge-work-plugins/it-audit/skills/2-policy-compliance-checker/scripts/checker.py --policy-folder "制度文件/"

# 指定输出报告路径
python .../checker.py --policy-folder "制度文件/" --output "reports/policy_check_20240227.json"

# 仅检查特定维度
python .../checker.py --policy-folder "制度文件/" --dimension "XC网络安全管理"

# 应用检查结果到数据库
python .../checker.py --policy-folder "制度文件/" --apply
```
